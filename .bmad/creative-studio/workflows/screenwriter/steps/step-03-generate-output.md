# Step 03: Generate Output Files

**Goal:** Create final screenplay file and tracking YAML, update pipeline state.

**Scope:** File creation and pipeline update.

**Token Budget:** ~350 tokens

---

## OUTPUT FILE CREATION

### File A: Screenplay Markdown

**File path:** `{active_project_path}/03-screenwriter/screenplay-{timestamp}.md`

**Timestamp format:** ISO8601 with hyphens: `YYYY-MM-DDTHH-MM-SSZ`

**Content structure:**

```markdown
# Screenplay: [Title]

## Metadata

- **Total Scenes:** {count}
- **Estimated Duration:** {X} minutes
- **Characters:** {comma-separated list}
- **Primary Locations:** {count} locations
- **Format Version:** standard_hollywood
- **Generated:** {timestamp}

## Characters

### {Character Name}
**First Appearance:** Scene {N}
**Description:** {Visual description from first appearance}

[Repeat for each character]

## Screenplay

FADE IN:

<!-- Scene 1 -->
<scene number="1" duration="45s">
  <slugline>EXT. FROZEN BEACH - DAWN</slugline>
  <location>Frozen Beach</location>
  <time>Dawn</time>
  <characters>Sarah</characters>
  <mood>melancholic, yearning</mood>
  <key_visuals>
    <visual>frozen shoreline with ice crystal formations</visual>
    <visual>woman in heavy wool coat, wind-blown hair</visual>
    <visual>pale winter sunrise over grey sea</visual>
  </key_visuals>
  <action>
Gray ice stretches to the horizon. The sea has frozen mid-wave, creating sculptural formations along the shore.

SARAH (38, weathered but elegant, wearing a heavy wool coat) stands alone at the water's edge. Wind whips her dark hair across her face. She doesn't brush it away.

Her eyes fix on the horizon‚Äîthe direction ships disappear.
  </action>
</scene>

---

<!-- Scene 2 -->
<scene number="2" duration="30s">
  [Continue for all scenes...]
</scene>

---

[All scenes...]

FADE OUT.

---

## Production Notes

### Locations Summary
| Location | INT/EXT | Scenes Used | Notes |
|----------|---------|-------------|-------|
| Frozen Beach | EXT | 1, 5, 12 | Requires ice/snow |
| Apartment | INT | 2, 6, 9 | Shrine corner setup |

### Props List
- Worn leather jacket (male)
- Heavy wool coat (female)
- Candles and small mementos (shrine)
[Complete list]

### Visual Consistency Notes
[Any notes about maintaining visual coherence]

---

*Generated by Screenwriter Workflow*
*Ready for: Production Validator*
```

### File B: Tracking Metadata (Optional)

**Note:** With per-project architecture, metadata can be embedded in the content file or stored separately as needed. The pipeline state in `pipeline-state.yaml` is the source of truth.

---

## UPDATE PIPELINE STATE

**CRITICAL:** Update BOTH the project-specific pipeline state AND the projects registry.

### Step C: Update Pipeline State

#### C1: Update Project Pipeline State

Use the **Edit** tool to update the per-project pipeline state file.

**Step 1:** Read projects registry to get active project path
**File:** `{project-root}/.bmad/creative-studio/_state/projects-registry.yaml`

**Step 2:** Edit the project's pipeline state file
**File:** `{active_project_path}/pipeline-state.yaml`

**Find this text (old_string):**
```yaml
current_stage: 2
last_updated: "{old_timestamp}"
```

**Replace with (new_string):**
```yaml
current_stage: 3
last_updated: "{timestamp}"
```

**THEN find this text (old_string):**
```yaml
  "03-screenwriter":
    status: "ready"
    outputs: []
    output_location: "/03-screenwriter/"
    input_from: "02-storyteller"
```

**Replace with (new_string):**
```yaml
  "03-screenwriter":
    status: "completed"
    completed_at: "{timestamp}"
    outputs: ["screenplay-{timestamp}.md"]
    output_location: "/03-screenwriter/"
    input_from: "02-storyteller"
```

**THEN find this text (old_string):**
```yaml
  "04-validator":
    status: "pending"
    outputs: []
    output_location: "/04-validator/"
    input_from: "03-screenwriter"
```

**Replace with (new_string):**
```yaml
  "04-validator":
    status: "ready"
    outputs: []
    output_location: "/04-validator/"
    input_from: "03-screenwriter"
```

**THEN find this text (old_string):**
```yaml
# Quick Access
next_stage_ready: true
next_stage: "03-screenwriter"
last_output: "/02-storyteller/scenes-{old_timestamp}.md"
```

**Replace with (new_string):**
```yaml
# Quick Access
next_stage_ready: true
next_stage: "04-validator"
last_output: "/03-screenwriter/screenplay-{timestamp}.md"
```

#### C2: Update Projects Registry

Use the **Edit** tool to update the registry.

**File:** `{project-root}/.bmad/creative-studio/_state/projects-registry.yaml`

**Find the active project entry and update:**

**Find this text (old_string):**
```yaml
    current_stage: 2
    stages_completed: ["01-diverse", "02-storyteller"]
```

**Replace with (new_string):**
```yaml
    current_stage: 3
    stages_completed: ["01-diverse", "02-storyteller", "03-screenwriter"]
```

---

## WORKFLOW COMPLETION

### Summary for User

```
‚úÖ Screenplay Formatting Complete!

üìÑ Screenplay: {file_path}
üé¨ Total Scenes: {count}
‚è±Ô∏è Estimated Duration: {duration}
üìç Locations: {location_count}
üé≠ Characters: {character_list}

FORMATTING APPLIED:
- Professional sluglines (INT/EXT. LOCATION - TIME)
- Visual-rich action lines
- XML tags for pipeline parsing
- Key visuals for each scene
- Props and locations documented

NEXT STEP OPTIONS:

1. **Continue to Production Validator**
   Verify screenplay is ready for image/video generation

2. **Review Screenplay**
   Read through the formatted screenplay

3. **Request Revisions**
   Ask for changes to specific scenes

4. **Exit Pipeline**
   Save progress and exit

What would you like to do?
```

---

## COMPLETION CHECKLIST

Before marking complete:

- [ ] Screenplay file written with all scenes
- [ ] All scenes have XML tags and key visuals
- [ ] Tracking YAML created with ALL handoff fields
- [ ] Location and prop lists compiled
- [ ] Pipeline state updated
- [ ] User presented with summary

---

**Screenwriter workflow complete. Ready for production-validator or user exit.**
